/*
脫退率計算   -- 2024.04.25

新增該年度有效件變數：契約狀態為有效 或 異動日大於等於 觀察年1月1日 --2024.05.13

*/

DROP TABLE IF EXISTS #EXRATE
DROP TABLE IF EXISTS #F1
DROP TABLE IF EXISTS #FINAL

DECLARE @DATE1 AS DATE,@DATE2 AS DATE,@DATE3 AS DATE,@DATE4 AS DATE,@DATE5 AS DATE

SET @DATE1 = DATEFROMPARTS(2019,1,1)   
SET @DATE2 = DATEFROMPARTS(2020,1,1) 
SET @DATE3 = DATEFROMPARTS(2021,1,1)   
SET @DATE4 = DATEFROMPARTS(2022,1,1) 
SET @DATE5 = DATEFROMPARTS(2023,1,1)   

 --匯率TABLE

CREATE TABLE #EXRATE
	(
	幣別 VARCHAR(20),
	匯率 FLOAT(20),
	)

INSERT INTO #EXRATE VALUES('AUD',20.9267),('CNY',4.3734),('EUR',34.1175),('USD',31.2705),('NTD',1)

SELECT *
  FROM #EXRATE
 

SELECT DISTINCT F1.[保單號碼]
			   ,F1.[BR_CODE]
			   ,F1.[BR生效日]
			   ,F1.[被保人生日]
			   ,F1.[性別]
			   ,F1.[險種]
			   ,F1.[通路]
			   ,F1.[狀態]
			   ,F1.異動日西元年
			   ,CASE WHEN F1.[狀態] = 'F' THEN DATEADD(MONTH,-26,F1.[異動日西元年])
					 ELSE F1.[異動日西元年] 
					 END AS '狀態異動日(停效日回推26月)'
			   ,F1.[保額(換算台幣)]
			   ,F1.[繳別]
			   ,F1.[表定年繳(換算台幣)]
			 --,F1.[計算日]
			   ,F1.[公司別]
			   ,F1.[險種分類]
			   ,F1.[RBC分類]
			   ,F1.[Misc分類]
			   ,F1.[表定分期繳]
			   ,F1.IES繳別CODE
			   ,F1.[幣別]
			   ,F1.[簡碼]
			   ,YEAR(@DATE1) AS Y1
			   ,YEAR(@DATE2) AS Y2
			   ,YEAR(@DATE3) AS Y3
			   ,YEAR(@DATE4) AS Y4
			   ,YEAR(@DATE5) AS Y5
  INTO #F1
  FROM (
  SELECT T1.S1701 AS '保單號碼'
		,T1.S1702 AS 'BR_CODE'
		,DATEFROMPARTS(CAST((CASE WHEN LEN(T1.S1703) = 7 THEN LEFT(T1.S1703,3) 
								WHEN LEN(T1.S1703) = 6 THEN LEFT(T1.S1703,2) 
								END) AS INT)+1911
					,CAST((CASE WHEN LEN(T1.S1703) = 7 THEN SUBSTRING(CAST(T1.S1703 AS varchar),4,2) 
								WHEN LEN(T1.S1703) = 6 THEN SUBSTRING(CAST(T1.S1703 AS varchar),3,2)
								END) AS int)
					,CAST((CASE WHEN (LEN(T1.S1703) = 7 AND SUBSTRING(CAST(T1.S1703 AS varchar),4,2) = '02' AND RIGHT(T1.S1703,2) = 29) OR (LEN(T1.S1703) = 6 AND SUBSTRING(CAST(T1.S1703 AS varchar),3,2) = '02' AND RIGHT(T1.S1703,2) = 29) THEN CASE WHEN (LEN(T1.S1703) = 7) AND ((CAST(LEFT(T1.S1703,3) AS INT) +1911-2000)%4<>0) THEN 28
																																																														WHEN (LEN(T1.S1703) = 6) AND ((CAST(LEFT(T1.S1703,2) AS INT) +1911-2000)%4<>0) THEN 28
																																																														ELSE 28
																																																														END
								ELSE RIGHT(T1.S1703,2)
								END) AS INT)
					) AS 'BR生效日'
		--,T1.S1704 AS '被保人生日'
		,DATEFROMPARTS(CAST((CASE WHEN LEN(T1.S1704) = 7 THEN LEFT(T1.S1704,3) 
								WHEN LEN(T1.S1704) = 6 THEN LEFT(T1.S1704,2) 
								END) AS INT)+1911
					,CAST((CASE WHEN LEN(T1.S1704) = 7 THEN SUBSTRING(CAST(T1.S1704 AS varchar),4,2) 
								WHEN LEN(T1.S1704) = 6 THEN SUBSTRING(CAST(T1.S1704 AS varchar),3,2)
								END) AS int)
					,CAST((CASE WHEN (LEN(T1.S1704) = 7 AND SUBSTRING(CAST(T1.S1704 AS varchar),4,2) = '02' AND RIGHT(T1.S1704,2) = 29) OR (LEN(T1.S1704) = 6 AND SUBSTRING(CAST(T1.S1704 AS varchar),3,2) = '02' AND RIGHT(T1.S1704,2) = 29) THEN CASE WHEN (LEN(T1.S1703) = 7) AND ((CAST(LEFT(T1.S1703,3) AS INT) +1911-2000)%4<>0) THEN 28
																																																														WHEN (LEN(T1.S1703) = 6) AND ((CAST(LEFT(T1.S1703,2) AS INT) +1911-2000)%4<>0) THEN 28
																																																														ELSE 29
																																																														END
								ELSE RIGHT(T1.S1704,2)
								END) AS INT)) AS '被保人生日'
		,T1.S1705 AS '性別'
		,T1.S1706 AS '險種'
		,T1.S1707 AS '通路'
		,T1.S1708 AS '狀態'
		,T1.S1709 AS '狀態異動日'
		,DATEFROMPARTS(CAST((CASE WHEN LEN(T1.S1709) < 6 THEN '0'
								WHEN LEN(T1.S1709) = 6 THEN LEFT(T1.S1709,2)
								WHEN LEN(T1.S1709) = 7 THEN LEFT(T1.S1709,3)
								WHEN LEN(T1.S1709) = 8 THEN LEFT(T1.S1709,3)
								END) AS INT) +1911
					,CAST((CASE WHEN LEN(T1.S1709) < 6 THEN '1'
								WHEN LEN(T1.S1709) = 6 THEN SUBSTRING(CAST(T1.S1709 AS varchar),3,2)
								WHEN LEN(T1.S1709) = 7 THEN SUBSTRING(CAST(T1.S1709 AS varchar),4,2) 
								WHEN LEN(T1.S1709) = 8 THEN SUBSTRING(CAST(T1.S1709 AS varchar),5,2)
								END) AS int)
					,CAST((CASE	WHEN LEN(T1.S1709) < 6 THEN '1'
								WHEN (LEN(T1.S1709) = 7 AND SUBSTRING(CAST(T1.S1709 AS varchar),4,2) = '02' AND RIGHT(T1.S1709,2) = 29) OR (LEN(T1.S1709) = 6 AND SUBSTRING(CAST(T1.S1709 AS varchar),3,2) = '02' AND RIGHT(T1.S1709,2) = 29) THEN CASE WHEN (LEN(T1.S1703) = 7) AND ((CAST(LEFT(T1.S1703,3) AS INT) +1911-2000)%4<>0) THEN 28
																																																														WHEN (LEN(T1.S1703) = 6) AND ((CAST(LEFT(T1.S1703,2) AS INT) +1911-2000)%4<>0) THEN 28
																																																														ELSE 28
																																																														END
								ELSE RIGHT(T1.S1709,2)
								END) AS INT)
					) AS '異動日西元年' 
		,T1.S1710 * EXRATE.匯率 AS '保額(換算台幣)'
		,T1.S1710 AS '保額'
		,T1.S1711 AS '繳別'
		,T1.S1712 AS '表定年繳保費'
		,T1.S1712 * EXRATE.匯率 AS '表定年繳(換算台幣)'
		--,T1.S1713 AS '計算日'
		,DATEFROMPARTS(LEFT(T1.S1713,3)+1911,CAST(SUBSTRING(CAST(T1.S1713 AS varchar),4,2)AS INT),RIGHT(T1.S1713,2)) AS '計算日'
		,CASE WHEN T1.S1707 = 'Z' THEN 'Z'
			  ELSE 'F'
			  END AS '公司別'
		,CASE WHEN T1.S1706 LIKE 'U%' THEN '萬能險'
			  WHEN T2.[ALPHC] = 'A' THEN '年金險'
			  WHEN T2.[ALPHC] = 'P' THEN '傷害險'
			  WHEN T2.[ALPHC] = 'H' THEN '醫療險'
			  WHEN T2.[ALPHC] = 'C' THEN '癌症險'
			  WHEN T2.[PDE] = 'P' THEN '生存險'
			  WHEN T2.[PDE] = 'D' THEN '死亡險'
			  WHEN T2.[PDE] = 'E' THEN '生死合險'
			  END AS '險種分類'
		,T2.[ALPHC]
		,T2.[PDE]
		,T2.[RBC分類]
		,CASE WHEN T2.[RBC分類] = '終身'   THEN 1
			  WHEN T2.[RBC分類] = '定期'   THEN 2
			  WHEN T2.[RBC分類] = '養老'   THEN 3
			  WHEN T2.[RBC分類] = '還本'   THEN 4
			  WHEN T2.[RBC分類] = '生存'   THEN 5
			  WHEN T2.[RBC分類] = '醫療險' THEN 6
			  WHEN T2.[RBC分類] = '癌症險' THEN 7
			  WHEN T2.[RBC分類] = '年金險' THEN 8
			  ELSE 9 END AS 'Misc分類'
		,CASE WHEN T1.S1711 = 'A' THEN T1.S1712 * EXRATE.匯率
			  WHEN T1.S1711 = 'M' THEN T1.S1712 * EXRATE.匯率 * 0.88
			  WHEN T1.S1711 = 'Q' THEN T1.S1712 * EXRATE.匯率 * 0.262
			  WHEN T1.S1711 = 'S' THEN T1.S1712 * EXRATE.匯率 * 0.52
			  END + 0.5 AS '表定分期繳'
	    ,CASE WHEN T1.S1711 = 'A' THEN 1
			  WHEN T1.S1711 = 'S' THEN 2
			  WHEN T1.S1711 = 'Q' THEN 4
			  WHEN T1.S1711 = 'M' THEN 12
			  ELSE 0 END AS 'IES繳別CODE'
		,T2.[險別分類]
		,T2.[LS]
		,T2.[幣別]
		,T2.[簡碼]
	FROM [ESMM].[dbo].[0208_STAA17PF_20240113_125500] AS T1
	LEFT JOIN [ESMM].[dbo].[0209_PRODUCTTYPE01_20240401_120000] AS T2 ON (CASE WHEN T1.S1707 = 'Z' THEN 'Z' ELSE 'F' END) = T2.公司代碼 AND T1.S1706 = T2.[PLAN]
	LEFT JOIN #EXRATE AS EXRATE ON  T2.[幣別] = EXRATE.幣別
	WHERE 1 = 1
	--AND T1.S1701 = '1010933052'
	--AND LEN(T1.S1704) > 5  -- 被保人生日大於六位數
	) AS F1
 WHERE 1 = 1
   AND F1.[簡碼] = 'HG1'
   --AND F1.[簡碼] IN ('HG1','HG2','HG3','HG4','HG5')
   AND F1.[險種] NOT LIKE 'V%' 
   AND F1.[險種] NOT LIKE 'UL%'
   AND F1.[狀態] NOT IN ('C','K','N','H','O')
  


SELECT DISTINCT F3.[保單號碼]
			   ,F3.[險種]
			   ,F3.[被保人生日]
			   ,F3.[投保年齡]
			   ,F3.[狀態]
			   ,F3.[狀態異動日(停效日回推26月)]
			   ,F3.[BR生效日]
			   ,F3.[表定年繳(換算台幣)]
			   ,F3.[狀態-死亡]
			   ,F3.[狀態-Lapsed]
			   --,F3.投保年齡
			   ,F3.Y1
			   ,CASE WHEN F3.[狀態] IN ('I','J','M','P','T','Y') THEN 'Y'
					 WHEN F3.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE1),1,1) THEN 'Y'
					 ELSE 'N'
					 END AS 'Y1_件數'
			   ,F3.Y1_AGE1
			   ,F3.Y1_AGE2
			   ,F3.Y1_曝露數1
			   ,F3.Y1_曝露數2
			   ,CAST(F3.Y1_曝露數1 AS FLOAT)/ (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE1),1,1),DATEFROMPARTS(YEAR(@DATE1),12,31)) +1) AS Y1_EXPOSURE1
			   ,CAST(F3.Y1_曝露數2 AS float) / (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE1),1,1),DATEFROMPARTS(YEAR(@DATE1),12,31)) +1) AS Y1_EXPOSURE2
			   ,CAST(F3.Y1_曝露數1 AS FLOAT)/ (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE1),1,1),DATEFROMPARTS(YEAR(@DATE1),12,31)) +1) * F3.[表定年繳(換算台幣)] AS Y1_ANNUAL_PERM1
			   ,CAST(F3.Y1_曝露數2 AS float) / (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE1),1,1),DATEFROMPARTS(YEAR(@DATE1),12,31)) +1) * F3.[表定年繳(換算台幣)] AS Y1_ANNUAL_PERM2
			   ,F3.Y2
			   ,CASE WHEN F3.[狀態] IN ('I','J','M','P','T','Y') THEN 'Y'
					 WHEN F3.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE2),1,1) THEN 'Y'
					 ELSE 'N'
					 END AS 'Y2_件數'
			   ,F3.Y2_AGE1
			   ,F3.Y2_AGE2
			   ,F3.Y2_曝露數1
			   ,F3.Y2_曝露數2
			   ,CAST(F3.Y2_曝露數1 AS float)/ (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE2),1,1),DATEFROMPARTS(YEAR(@DATE2),12,31)) +1) AS Y2_EXPOSURE1
			   ,CAST(F3.Y2_曝露數2 AS float) / (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE2),1,1),DATEFROMPARTS(YEAR(@DATE2),12,31)) +1) AS Y2_EXPOSURE2
			   ,CAST(F3.Y2_曝露數1 AS float)/ (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE2),1,1),DATEFROMPARTS(YEAR(@DATE2),12,31)) +1) * F3.[表定年繳(換算台幣)] AS Y2_ANNUAL_PERM1
			   ,CAST(F3.Y2_曝露數2 AS float) / (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE2),1,1),DATEFROMPARTS(YEAR(@DATE2),12,31)) +1) * F3.[表定年繳(換算台幣)] AS Y2_ANNUAL_PERM2
			   ,F3.Y3
			   ,CASE WHEN F3.[狀態] IN ('I','J','M','P','T','Y') THEN 'Y'
					 WHEN F3.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE3),1,1) THEN 'Y'
					 ELSE 'N'
					 END AS 'Y3_件數'
			   ,F3.Y3_AGE1
			   ,F3.Y3_AGE2
			   ,F3.Y3_曝露數1
			   ,F3.Y3_曝露數2
			   ,CAST(F3.Y3_曝露數1 AS float)/ (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE3),1,1),DATEFROMPARTS(YEAR(@DATE3),12,31)) +1) AS Y3_EXPOSURE1
			   ,CAST(F3.Y3_曝露數2 AS FLOAT)/ (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE3),1,1),DATEFROMPARTS(YEAR(@DATE3),12,31)) +1) AS Y3_EXPOSURE2
			   ,CAST(F3.Y3_曝露數1 AS float)/ (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE3),1,1),DATEFROMPARTS(YEAR(@DATE3),12,31)) +1) * F3.[表定年繳(換算台幣)] AS Y3_ANNUAL_PERM1
			   ,CAST(F3.Y3_曝露數2 AS FLOAT)/ (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE3),1,1),DATEFROMPARTS(YEAR(@DATE3),12,31)) +1) * F3.[表定年繳(換算台幣)] AS Y3_ANNUAL_PERM2
			   ,F3.Y4
			   ,CASE WHEN F3.[狀態] IN ('I','J','M','P','T','Y') THEN 'Y'
					 WHEN F3.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE4),1,1) THEN 'Y'
					 ELSE 'N'
					 END AS 'Y4_件數'
			   ,F3.Y4_AGE1
			   ,F3.Y4_AGE2
			   ,F3.Y4_曝露數1
			   ,F3.Y4_曝露數2
			   ,CAST(F3.Y4_曝露數1 AS float)/ (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE4),1,1),DATEFROMPARTS(YEAR(@DATE4),12,31)) +1) AS Y4_EXPOSURE1
			   ,CAST(F3.Y4_曝露數2 AS FLOAT)/ (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE4),1,1),DATEFROMPARTS(YEAR(@DATE4),12,31)) +1) AS Y4_EXPOSURE2
			   ,CAST(F3.Y4_曝露數1 AS float)/ (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE4),1,1),DATEFROMPARTS(YEAR(@DATE4),12,31)) +1) * F3.[表定年繳(換算台幣)] AS Y4_ANNUAL_PERM1
			   ,CAST(F3.Y4_曝露數2 AS FLOAT)/ (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE4),1,1),DATEFROMPARTS(YEAR(@DATE4),12,31)) +1) * F3.[表定年繳(換算台幣)] AS Y4_ANNUAL_PERM2
			   ,F3.Y5
			   ,CASE WHEN F3.[狀態] IN ('I','J','M','P','T','Y') THEN 'Y'
					 WHEN F3.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE5),1,1) THEN 'Y'
					 ELSE 'N'
					 END AS 'Y5_件數'
			   ,F3.Y5_AGE1
			   ,F3.Y5_AGE2
			   ,F3.Y5_曝露數1
			   ,F3.Y5_曝露數2
			   ,CAST(F3.Y5_曝露數1 AS float) / (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE5),1,1),DATEFROMPARTS(YEAR(@DATE5),12,31)) +1) AS Y5_EXPOSURE1
			   ,CAST(F3.Y5_曝露數2 AS float)/ (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE5),1,1),DATEFROMPARTS(YEAR(@DATE5),12,31)) +1) AS Y5_EXPOSURE2
			   ,CAST(F3.Y5_曝露數1 AS float) / (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE5),1,1),DATEFROMPARTS(YEAR(@DATE5),12,31)) +1) * F3.[表定年繳(換算台幣)] AS Y5_ANNUAL_PERM1
			   ,CAST(F3.Y5_曝露數2 AS float)/ (DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE5),1,1),DATEFROMPARTS(YEAR(@DATE5),12,31)) +1) * F3.[表定年繳(換算台幣)] AS Y5_ANNUAL_PERM2
  INTO #FINAL
  FROM (
SELECT F2.*
	  ,CASE WHEN F2.狀態 IN ('A','D','W') THEN 'Y'
			ELSE 'N' END AS'狀態-死亡'
	  ,CASE WHEN F2.狀態 IN ('E','F','L','R','S') THEN 'Y'
			ELSE 'N' END AS'狀態-Lapsed'
	  ,YEAR(@DATE1) AS Y1
	  ,YEAR(@DATE1) - YEAR(F2.[BR生效日]) + F2.投保年齡 - 1 AS 'Y1_AGE1'
	  ,YEAR(@DATE1) - YEAR(F2.[BR生效日]) + F2.投保年齡 AS 'Y1_AGE2'
	  ,YEAR(@DATE2) AS Y2
	  ,YEAR(@DATE2) - YEAR(F2.[BR生效日]) + F2.投保年齡 - 1 AS 'Y2_AGE1'
	  ,YEAR(@DATE2) - YEAR(F2.[BR生效日]) + F2.投保年齡 AS 'Y2_AGE2'
	  ,YEAR(@DATE3) AS Y3
	  ,YEAR(@DATE3) - YEAR(F2.[BR生效日]) + F2.投保年齡 - 1 AS 'Y3_AGE1'
	  ,YEAR(@DATE3) - YEAR(F2.[BR生效日]) + F2.投保年齡 AS 'Y3_AGE2'
	  ,YEAR(@DATE4) AS Y4
	  ,YEAR(@DATE4) - YEAR(F2.[BR生效日]) + F2.投保年齡 - 1 'Y4_AGE1'
	  ,YEAR(@DATE4) - YEAR(F2.[BR生效日]) + F2.投保年齡 AS 'Y4_AGE2'
	  ,YEAR(@DATE5) AS Y5
	  ,YEAR(@DATE5) - YEAR(F2.[BR生效日]) + F2.投保年齡 - 1 AS 'Y5_AGE1'
	  ,YEAR(@DATE5) - YEAR(F2.[BR生效日]) + F2.投保年齡 AS 'Y5_AGE2'
	  -- Y1_AGE1曝露數 
	  , CASE WHEN YEAR(@DATE1) < YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE1) = YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE1) > YEAR(F2.[BR生效日])  THEN CASE
			 WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE1),1,1),DATEFROMPARTS(YEAR(@DATE1),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))   -- 沒異動
			 WHEN YEAR (F2.[狀態異動日(停效日回推26月)]) < YEAR(@DATE1) THEN 0  -- 異動年再觀察年之前
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(DATEFROMPARTS(YEAR(@DATE1),1,1)) THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE1),1,1),DATEFROMPARTS(YEAR(@DATE1),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))   -- 沒異動
																										  WHEN F2.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE1),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE1),1,1),DATEFROMPARTS(YEAR(@DATE1),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日]))) 
																										  WHEN F2.[狀態異動日(停效日回推26月)] < DATEFROMPARTS(YEAR(@DATE1),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE1),1,1),F2.[狀態異動日(停效日回推26月)]) 
																										  END
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(DATEFROMPARTS(YEAR(@DATE1),12,31)) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE1),1,1),DATEFROMPARTS(YEAR(@DATE1),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))    -- 異動年再觀察年之後
			 END END AS 'Y1_曝露數1'
	  -- Y1_AGE2曝露數
	  , CASE WHEN YEAR(@DATE1) < YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE1) = YEAR(F2.[BR生效日])  THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE1),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE1),12,31)) +1  --沒異動
																WHEN  YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(@DATE1) THEN DATEDIFF("D",F2.[BR生效日],F2.[狀態異動日(停效日回推26月)]) 
																WHEN  YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(@DATE1) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE1),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE1),12,31)) +1 
																END
			 WHEN YEAR(@DATE1) > YEAR(F2.[BR生效日])  THEN CASE 
			 WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE1),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE1),12,31)) +1  --沒異動
			 WHEN YEAR (F2.[狀態異動日(停效日回推26月)]) < YEAR(DATEFROMPARTS(YEAR(@DATE1),1,1)) THEN 0		--異動年再觀察年之前
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(DATEFROMPARTS(YEAR(@DATE1),1,1)) THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE1),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE1),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),F2.[狀態異動日(停效日回推26月)])
																										  WHEN F2.[狀態異動日(停效日回推26月)] < DATEFROMPARTS(YEAR(@DATE1),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN 0
																										  END
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(DATEFROMPARTS(YEAR(@DATE1),12,31)) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE1),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE1),12,31)) +1 -- 異動年再觀察年之後
			 END END AS 'Y1_曝露數2'	
	  -- Y2_AGE1曝露數 
	  , CASE WHEN YEAR(@DATE2) < YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE2) = YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE2) > YEAR(F2.[BR生效日])  THEN CASE
			 WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE2),1,1),DATEFROMPARTS(YEAR(@DATE2),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))   -- 沒異動
			 WHEN YEAR (F2.[狀態異動日(停效日回推26月)]) < YEAR(@DATE2) THEN 0  -- 異動年再觀察年之前
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(DATEFROMPARTS(YEAR(@DATE2),1,1)) THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE2),1,1),DATEFROMPARTS(YEAR(@DATE2),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))   -- 沒異動
																										  WHEN F2.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE2),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE2),1,1),DATEFROMPARTS(YEAR(@DATE2),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日]))) 
																										  WHEN F2.[狀態異動日(停效日回推26月)] < DATEFROMPARTS(YEAR(@DATE2),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE2),1,1),F2.[狀態異動日(停效日回推26月)]) 
																										  END
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(DATEFROMPARTS(YEAR(@DATE2),12,31)) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE2),1,1),DATEFROMPARTS(YEAR(@DATE2),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))    -- 異動年再觀察年之後
			 END END AS 'Y2_曝露數1'
	  -- Y2_AGE2曝露數
	  , CASE WHEN YEAR(@DATE2) < YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE2) = YEAR(F2.[BR生效日])  THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE2),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE2),12,31)) +1  --沒異動
																WHEN  YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(@DATE2) THEN DATEDIFF("D",F2.[BR生效日],F2.[狀態異動日(停效日回推26月)]) 
																WHEN  YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(@DATE2) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE2),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE2),12,31)) +1 
																END
			 WHEN YEAR(@DATE2) > YEAR(F2.[BR生效日])  THEN CASE 
			 WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE2),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE2),12,31)) +1  --沒異動
			 WHEN YEAR (F2.[狀態異動日(停效日回推26月)]) < YEAR(DATEFROMPARTS(YEAR(@DATE2),1,1)) THEN 0		--異動年再觀察年之前
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(DATEFROMPARTS(YEAR(@DATE2),1,1)) THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE2),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE2),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),F2.[狀態異動日(停效日回推26月)])
																										  WHEN F2.[狀態異動日(停效日回推26月)] < DATEFROMPARTS(YEAR(@DATE2),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN 0
																										  END
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(DATEFROMPARTS(YEAR(@DATE2),12,31)) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE2),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE2),12,31)) +1 -- 異動年再觀察年之後
			 END END AS 'Y2_曝露數2'	
	  -- Y3_AGE1曝露數 
	  , CASE WHEN YEAR(@DATE3) < YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE3) = YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE3) > YEAR(F2.[BR生效日])  THEN CASE
			 WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE3),1,1),DATEFROMPARTS(YEAR(@DATE3),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))   -- 沒異動
			 WHEN YEAR (F2.[狀態異動日(停效日回推26月)]) < YEAR(@DATE3) THEN 0  -- 異動年再觀察年之前
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(DATEFROMPARTS(YEAR(@DATE3),1,1)) THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE3),1,1),DATEFROMPARTS(YEAR(@DATE3),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))   -- 沒異動
																										  WHEN F2.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE3),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE3),1,1),DATEFROMPARTS(YEAR(@DATE3),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日]))) 
																										  WHEN F2.[狀態異動日(停效日回推26月)] < DATEFROMPARTS(YEAR(@DATE3),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE3),1,1),F2.[狀態異動日(停效日回推26月)]) 
																										  END
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(DATEFROMPARTS(YEAR(@DATE3),12,31)) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE3),1,1),DATEFROMPARTS(YEAR(@DATE3),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))    -- 異動年再觀察年之後
			 END END AS 'Y3_曝露數1'
	  -- Y3_AGE2曝露數
	  , CASE WHEN YEAR(@DATE3) < YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE3) = YEAR(F2.[BR生效日])  THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE3),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE3),12,31)) +1  --沒異動
																WHEN  YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(@DATE3) THEN DATEDIFF("D",F2.[BR生效日],F2.[狀態異動日(停效日回推26月)]) 
																WHEN  YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(@DATE3) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE3),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE3),12,31)) +1 
																END
			 WHEN YEAR(@DATE3) > YEAR(F2.[BR生效日])  THEN CASE 
			 WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE3),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE3),12,31)) +1  --沒異動
			 WHEN YEAR (F2.[狀態異動日(停效日回推26月)]) < YEAR(DATEFROMPARTS(YEAR(@DATE3),1,1)) THEN 0		--異動年再觀察年之前
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(DATEFROMPARTS(YEAR(@DATE3),1,1)) THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE3),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE3),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),F2.[狀態異動日(停效日回推26月)])
																										  WHEN F2.[狀態異動日(停效日回推26月)] < DATEFROMPARTS(YEAR(@DATE3),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN 0
																										  END
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(DATEFROMPARTS(YEAR(@DATE3),12,31)) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE3),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE3),12,31)) +1 -- 異動年再觀察年之後
			 END END AS 'Y3_曝露數2'	
	  -- Y4_AGE1曝露數 
	  , CASE WHEN YEAR(@DATE4) < YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE4) = YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE4) > YEAR(F2.[BR生效日])  THEN CASE
			 WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE4),1,1),DATEFROMPARTS(YEAR(@DATE4),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))   -- 沒異動
			 WHEN YEAR (F2.[狀態異動日(停效日回推26月)]) < YEAR(@DATE4) THEN 0  -- 異動年再觀察年之前
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(DATEFROMPARTS(YEAR(@DATE4),1,1)) THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE4),1,1),DATEFROMPARTS(YEAR(@DATE4),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))   -- 沒異動
																										  WHEN F2.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE4),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE4),1,1),DATEFROMPARTS(YEAR(@DATE4),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日]))) 
																										  WHEN F2.[狀態異動日(停效日回推26月)] < DATEFROMPARTS(YEAR(@DATE4),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE4),1,1),F2.[狀態異動日(停效日回推26月)]) 
																										  END
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(DATEFROMPARTS(YEAR(@DATE4),12,31)) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE4),1,1),DATEFROMPARTS(YEAR(@DATE4),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))    -- 異動年再觀察年之後
			 END END AS 'Y4_曝露數1'
	  -- Y4_AGE2曝露數
	  , CASE WHEN YEAR(@DATE4) < YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE4) = YEAR(F2.[BR生效日])  THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE4),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE4),12,31)) +1  --沒異動
																WHEN  YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(@DATE4) THEN DATEDIFF("D",F2.[BR生效日],F2.[狀態異動日(停效日回推26月)]) 
																WHEN  YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(@DATE4) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE4),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE4),12,31)) +1 
																END
			 WHEN YEAR(@DATE4) > YEAR(F2.[BR生效日])  THEN CASE 
			 WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE4),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE4),12,31)) +1  --沒異動
			 WHEN YEAR (F2.[狀態異動日(停效日回推26月)]) < YEAR(DATEFROMPARTS(YEAR(@DATE4),1,1)) THEN 0		--異動年再觀察年之前
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(DATEFROMPARTS(YEAR(@DATE4),1,1)) THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE4),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE4),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),F2.[狀態異動日(停效日回推26月)])
																										  WHEN F2.[狀態異動日(停效日回推26月)] < DATEFROMPARTS(YEAR(@DATE4),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN 0
																										  END
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(DATEFROMPARTS(YEAR(@DATE4),12,31)) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE4),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE4),12,31)) +1 -- 異動年再觀察年之後
			 END END AS 'Y4_曝露數2'	
	  -- Y5_AGE1曝露數 
	  , CASE WHEN YEAR(@DATE5) < YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE5) = YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE5) > YEAR(F2.[BR生效日])  THEN CASE
			 WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE5),1,1),DATEFROMPARTS(YEAR(@DATE5),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))   -- 沒異動
			 WHEN YEAR (F2.[狀態異動日(停效日回推26月)]) < YEAR(@DATE5) THEN 0  -- 異動年再觀察年之前
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(DATEFROMPARTS(YEAR(@DATE5),1,1)) THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE5),1,1),DATEFROMPARTS(YEAR(@DATE5),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))   -- 沒異動
																										  WHEN F2.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE5),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE5),1,1),DATEFROMPARTS(YEAR(@DATE5),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日]))) 
																										  WHEN F2.[狀態異動日(停效日回推26月)] < DATEFROMPARTS(YEAR(@DATE5),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE5),1,1),F2.[狀態異動日(停效日回推26月)]) 
																										  END
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(DATEFROMPARTS(YEAR(@DATE5),12,31)) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE5),1,1),DATEFROMPARTS(YEAR(@DATE5),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])))    -- 異動年再觀察年之後
			 END END AS 'Y5_曝露數1'
	  -- Y5_AGE2曝露數
	  , CASE WHEN YEAR(@DATE5) < YEAR(F2.[BR生效日])  THEN 0
			 WHEN YEAR(@DATE5) = YEAR(F2.[BR生效日])  THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE5),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE5),12,31)) +1  --沒異動
																WHEN  YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(@DATE5) THEN DATEDIFF("D",F2.[BR生效日],F2.[狀態異動日(停效日回推26月)]) 
																WHEN  YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(@DATE5) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE5),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE5),12,31)) +1 
																END
			 WHEN YEAR(@DATE5) > YEAR(F2.[BR生效日])  THEN CASE 
			 WHEN F2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE5),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE5),12,31)) +1  --沒異動
			 WHEN YEAR (F2.[狀態異動日(停效日回推26月)]) < YEAR(DATEFROMPARTS(YEAR(@DATE5),1,1)) THEN 0		--異動年再觀察年之前
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) = YEAR(DATEFROMPARTS(YEAR(@DATE5),1,1)) THEN CASE WHEN F2.[狀態異動日(停效日回推26月)] >= DATEFROMPARTS(YEAR(@DATE5),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE5),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),F2.[狀態異動日(停效日回推26月)])
																										  WHEN F2.[狀態異動日(停效日回推26月)] < DATEFROMPARTS(YEAR(@DATE5),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])) THEN 0
																										  END
			 WHEN YEAR(F2.[狀態異動日(停效日回推26月)]) > YEAR(DATEFROMPARTS(YEAR(@DATE5),12,31)) THEN DATEDIFF("D",DATEFROMPARTS(YEAR(@DATE5),MONTH(F2.[BR生效日]),DAY(F2.[BR生效日])),DATEFROMPARTS(YEAR(@DATE5),12,31)) +1 -- 異動年再觀察年之後
			 END END AS 'Y5_曝露數2'	
	  FROM (
		SELECT DISTINCT F1.[保單號碼]
					   ,F1.[被保人生日]
					   ,F1.[險種]
					   ,CASE WHEN (DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日])) >  6  THEN DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]) + 1
							   WHEN (DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日])) =  6  AND  (DATEDIFF(DAY,DATEADD(MONTH,DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]),DATEADD(YEAR,DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]),F1.[被保人生日])),F1.[BR生效日])) > 0 THEN DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]) + 1
							   WHEN (DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日])) =  6  AND  (DATEDIFF(DAY,DATEADD(MONTH,DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]),DATEADD(YEAR,DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]),F1.[被保人生日])),F1.[BR生效日])) = 0 THEN DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]) + 1
							   WHEN (DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日])) =  6  AND  (DATEDIFF(DAY,DATEADD(MONTH,DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]),DATEADD(YEAR,DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]),F1.[被保人生日])),F1.[BR生效日])) < 0 THEN DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]) 
							   WHEN (DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日])) <  6  AND  (DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日])) >=  0 THEN DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]) 
							   WHEN (DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日])) > -6  AND  (DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日])) < 0THEN DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]) 
							   WHEN (DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日])) = -6  AND  (DATEDIFF(DAY,DATEADD(MONTH,DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]),DATEADD(YEAR,DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]),F1.[被保人生日])),F1.[BR生效日])) > 0 THEN DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]) 
							   WHEN (DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日])) = -6  AND  (DATEDIFF(DAY,DATEADD(MONTH,DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]),DATEADD(YEAR,DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]),F1.[被保人生日])),F1.[BR生效日])) = 0 THEN DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]) - 1
							   WHEN (DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日])) = -6  AND  (DATEDIFF(DAY,DATEADD(MONTH,DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]),DATEADD(YEAR,DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]),F1.[被保人生日])),F1.[BR生效日])) < 0 THEN DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]) - 1
							   WHEN (DATEDIFF(MONTH,F1.[被保人生日],F1.[BR生效日]) - 12*DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日])) < -6  THEN DATEDIFF(YEAR,F1.[被保人生日],F1.[BR生效日]) - 1
							   END AS '投保年齡'
						 ,F1.[狀態]
						 ,F1.[狀態異動日(停效日回推26月)]
						 ,F1.[BR生效日]
						 ,F1.[表定年繳(換算台幣)]
		  FROM #F1 F1
		 WHERE 1 = 1
		) AS F2
	) AS F3
 WHERE 1 = 1


--/*

--計算

--*/

----件數
SELECT T2.[Attained Age],SUM(T2.件數)
  FROM (
SELECT CASE WHEN T1.Y5_AGE1 BETWEEN 0 AND 19 THEN '0-19'
			WHEN T1.Y5_AGE1 BETWEEN 20 AND 24 THEN '20-24'
			WHEN T1.Y5_AGE1 BETWEEN 25 AND 29 THEN '25-29'
			WHEN T1.Y5_AGE1 BETWEEN 30 AND 34 THEN '30-34'
			WHEN T1.Y5_AGE1 BETWEEN 35 AND 39 THEN '35-39'
			WHEN T1.Y5_AGE1 BETWEEN 40 AND 44 THEN '40-44'
			WHEN T1.Y5_AGE1 BETWEEN 45 AND 49 THEN '45-49'
			WHEN T1.Y5_AGE1 BETWEEN 50 AND 54 THEN '50-54'
			WHEN T1.Y5_AGE1 BETWEEN 55 AND 59 THEN '55-59'
			WHEN T1.Y5_AGE1 BETWEEN 60 AND 64 THEN '60-64'
			WHEN T1.Y5_AGE1 BETWEEN 65 AND 69 THEN '65-69'
			WHEN T1.Y5_AGE1 BETWEEN 70 AND 74 THEN '70-74'
			WHEN T1.Y5_AGE1 BETWEEN 75 AND 79 THEN '75-79'
			WHEN T1.Y5_AGE1 BETWEEN 80 AND 120 THEN '80-120'
			ELSE 'Unknown' END AS 'Attained Age'
	  ,SUM(T1.Y5_EXPOSURE1) AS '件數'
  FROM #FINAL AS T1
 WHERE 1 = 1
   AND T1.Y5_件數 = 'Y'
   AND T1.狀態 NOT IN ('A','D','S')
 GROUP BY CASE WHEN T1.Y5_AGE1 BETWEEN 0 AND 19 THEN '0-19'
			   WHEN T1.Y5_AGE1 BETWEEN 20 AND 24 THEN '20-24'
			   WHEN T1.Y5_AGE1 BETWEEN 25 AND 29 THEN '25-29'
			   WHEN T1.Y5_AGE1 BETWEEN 30 AND 34 THEN '30-34'
			   WHEN T1.Y5_AGE1 BETWEEN 35 AND 39 THEN '35-39'
			   WHEN T1.Y5_AGE1 BETWEEN 40 AND 44 THEN '40-44'
			   WHEN T1.Y5_AGE1 BETWEEN 45 AND 49 THEN '45-49'
			   WHEN T1.Y5_AGE1 BETWEEN 50 AND 54 THEN '50-54'
			   WHEN T1.Y5_AGE1 BETWEEN 55 AND 59 THEN '55-59'
			   WHEN T1.Y5_AGE1 BETWEEN 60 AND 64 THEN '60-64'
			   WHEN T1.Y5_AGE1 BETWEEN 65 AND 69 THEN '65-69'
			   WHEN T1.Y5_AGE1 BETWEEN 70 AND 74 THEN '70-74'
			   WHEN T1.Y5_AGE1 BETWEEN 75 AND 79 THEN '75-79'
			   WHEN T1.Y5_AGE1 BETWEEN 80 AND 120 THEN '80-120'
			   ELSE 'Unknown' END

UNION ALL

SELECT CASE WHEN T1.Y5_AGE2 BETWEEN 0 AND 19 THEN '0-19'
			WHEN T1.Y5_AGE2 BETWEEN 20 AND 24 THEN '20-24'
			WHEN T1.Y5_AGE2 BETWEEN 25 AND 29 THEN '25-29'
			WHEN T1.Y5_AGE2 BETWEEN 30 AND 34 THEN '30-34'
			WHEN T1.Y5_AGE2 BETWEEN 35 AND 39 THEN '35-39'
			WHEN T1.Y5_AGE2 BETWEEN 40 AND 44 THEN '40-44'
			WHEN T1.Y5_AGE2 BETWEEN 45 AND 49 THEN '45-49'
			WHEN T1.Y5_AGE2 BETWEEN 50 AND 54 THEN '50-54'
			WHEN T1.Y5_AGE2 BETWEEN 55 AND 59 THEN '55-59'
			WHEN T1.Y5_AGE2 BETWEEN 60 AND 64 THEN '60-64'
			WHEN T1.Y5_AGE2 BETWEEN 65 AND 69 THEN '65-69'
			WHEN T1.Y5_AGE2 BETWEEN 70 AND 74 THEN '70-74'
			WHEN T1.Y5_AGE2 BETWEEN 75 AND 79 THEN '75-79'
			WHEN T1.Y5_AGE2 BETWEEN 80 AND 120 THEN '80-120'
			ELSE 'Unknown' END AS 'Attained Age'
	  ,SUM(T1.Y5_EXPOSURE2) AS '件數'
  FROM #FINAL AS T1
 WHERE 1 = 1
   AND T1.Y5_件數 = 'Y'
   AND T1.狀態 NOT IN ('A','D','S')
 GROUP BY CASE WHEN T1.Y5_AGE2 BETWEEN 0 AND 19 THEN '0-19'
			   WHEN T1.Y5_AGE2 BETWEEN 20 AND 24 THEN '20-24'
			   WHEN T1.Y5_AGE2 BETWEEN 25 AND 29 THEN '25-29'
			   WHEN T1.Y5_AGE2 BETWEEN 30 AND 34 THEN '30-34'
			   WHEN T1.Y5_AGE2 BETWEEN 35 AND 39 THEN '35-39'
			   WHEN T1.Y5_AGE2 BETWEEN 40 AND 44 THEN '40-44'
			   WHEN T1.Y5_AGE2 BETWEEN 45 AND 49 THEN '45-49'
			   WHEN T1.Y5_AGE2 BETWEEN 50 AND 54 THEN '50-54'
			   WHEN T1.Y5_AGE2 BETWEEN 55 AND 59 THEN '55-59'
			   WHEN T1.Y5_AGE2 BETWEEN 60 AND 64 THEN '60-64'
			   WHEN T1.Y5_AGE2 BETWEEN 65 AND 69 THEN '65-69'
			   WHEN T1.Y5_AGE2 BETWEEN 70 AND 74 THEN '70-74'
			   WHEN T1.Y5_AGE2 BETWEEN 75 AND 79 THEN '75-79'
			   WHEN T1.Y5_AGE2 BETWEEN 80 AND 120 THEN '80-120'
			   ELSE 'Unknown' END
	) AS T2
 GROUP BY T2.[Attained Age]

 SELECT T2.[Attained Age],SUM(T2.件數)
  FROM (
SELECT CASE WHEN T1.Y5_AGE1 BETWEEN 0 AND 19 THEN '0-19'
			WHEN T1.Y5_AGE1 BETWEEN 20 AND 24 THEN '20-24'
			WHEN T1.Y5_AGE1 BETWEEN 25 AND 29 THEN '25-29'
			WHEN T1.Y5_AGE1 BETWEEN 30 AND 34 THEN '30-34'
			WHEN T1.Y5_AGE1 BETWEEN 35 AND 39 THEN '35-39'
			WHEN T1.Y5_AGE1 BETWEEN 40 AND 44 THEN '40-44'
			WHEN T1.Y5_AGE1 BETWEEN 45 AND 49 THEN '45-49'
			WHEN T1.Y5_AGE1 BETWEEN 50 AND 54 THEN '50-54'
			WHEN T1.Y5_AGE1 BETWEEN 55 AND 59 THEN '55-59'
			WHEN T1.Y5_AGE1 BETWEEN 60 AND 64 THEN '60-64'
			WHEN T1.Y5_AGE1 BETWEEN 65 AND 69 THEN '65-69'
			WHEN T1.Y5_AGE1 BETWEEN 70 AND 74 THEN '70-74'
			WHEN T1.Y5_AGE1 BETWEEN 75 AND 79 THEN '75-79'
			WHEN T1.Y5_AGE1 BETWEEN 80 AND 120 THEN '80-120'
			ELSE 'Unknown' END AS 'Attained Age'
	  ,SUM(T1.Y5_EXPOSURE1) AS '件數'
  FROM #FINAL AS T1
 WHERE 1 = 1
   AND T1.Y5_件數 = 'Y'
   AND T1.狀態 = 'L'
 GROUP BY CASE WHEN T1.Y5_AGE1 BETWEEN 0 AND 19 THEN '0-19'
			   WHEN T1.Y5_AGE1 BETWEEN 20 AND 24 THEN '20-24'
			   WHEN T1.Y5_AGE1 BETWEEN 25 AND 29 THEN '25-29'
			   WHEN T1.Y5_AGE1 BETWEEN 30 AND 34 THEN '30-34'
			   WHEN T1.Y5_AGE1 BETWEEN 35 AND 39 THEN '35-39'
			   WHEN T1.Y5_AGE1 BETWEEN 40 AND 44 THEN '40-44'
			   WHEN T1.Y5_AGE1 BETWEEN 45 AND 49 THEN '45-49'
			   WHEN T1.Y5_AGE1 BETWEEN 50 AND 54 THEN '50-54'
			   WHEN T1.Y5_AGE1 BETWEEN 55 AND 59 THEN '55-59'
			   WHEN T1.Y5_AGE1 BETWEEN 60 AND 64 THEN '60-64'
			   WHEN T1.Y5_AGE1 BETWEEN 65 AND 69 THEN '65-69'
			   WHEN T1.Y5_AGE1 BETWEEN 70 AND 74 THEN '70-74'
			   WHEN T1.Y5_AGE1 BETWEEN 75 AND 79 THEN '75-79'
			   WHEN T1.Y5_AGE1 BETWEEN 80 AND 120 THEN '80-120'
			   ELSE 'Unknown' END

UNION ALL

SELECT CASE WHEN T1.Y5_AGE2 BETWEEN 0 AND 19 THEN '0-19'
			WHEN T1.Y5_AGE2 BETWEEN 20 AND 24 THEN '20-24'
			WHEN T1.Y5_AGE2 BETWEEN 25 AND 29 THEN '25-29'
			WHEN T1.Y5_AGE2 BETWEEN 30 AND 34 THEN '30-34'
			WHEN T1.Y5_AGE2 BETWEEN 35 AND 39 THEN '35-39'
			WHEN T1.Y5_AGE2 BETWEEN 40 AND 44 THEN '40-44'
			WHEN T1.Y5_AGE2 BETWEEN 45 AND 49 THEN '45-49'
			WHEN T1.Y5_AGE2 BETWEEN 50 AND 54 THEN '50-54'
			WHEN T1.Y5_AGE2 BETWEEN 55 AND 59 THEN '55-59'
			WHEN T1.Y5_AGE2 BETWEEN 60 AND 64 THEN '60-64'
			WHEN T1.Y5_AGE2 BETWEEN 65 AND 69 THEN '65-69'
			WHEN T1.Y5_AGE2 BETWEEN 70 AND 74 THEN '70-74'
			WHEN T1.Y5_AGE2 BETWEEN 75 AND 79 THEN '75-79'
			WHEN T1.Y5_AGE2 BETWEEN 80 AND 120 THEN '80-120'
			ELSE 'Unknown' END AS 'Attained Age'
	  ,SUM(T1.Y5_EXPOSURE2) AS '件數'
  FROM #FINAL AS T1
 WHERE 1 = 1
   AND T1.Y5_件數 = 'Y'
   AND T1.狀態 ='L'
 GROUP BY CASE WHEN T1.Y5_AGE2 BETWEEN 0 AND 19 THEN '0-19'
			   WHEN T1.Y5_AGE2 BETWEEN 20 AND 24 THEN '20-24'
			   WHEN T1.Y5_AGE2 BETWEEN 25 AND 29 THEN '25-29'
			   WHEN T1.Y5_AGE2 BETWEEN 30 AND 34 THEN '30-34'
			   WHEN T1.Y5_AGE2 BETWEEN 35 AND 39 THEN '35-39'
			   WHEN T1.Y5_AGE2 BETWEEN 40 AND 44 THEN '40-44'
			   WHEN T1.Y5_AGE2 BETWEEN 45 AND 49 THEN '45-49'
			   WHEN T1.Y5_AGE2 BETWEEN 50 AND 54 THEN '50-54'
			   WHEN T1.Y5_AGE2 BETWEEN 55 AND 59 THEN '55-59'
			   WHEN T1.Y5_AGE2 BETWEEN 60 AND 64 THEN '60-64'
			   WHEN T1.Y5_AGE2 BETWEEN 65 AND 69 THEN '65-69'
			   WHEN T1.Y5_AGE2 BETWEEN 70 AND 74 THEN '70-74'
			   WHEN T1.Y5_AGE2 BETWEEN 75 AND 79 THEN '75-79'
			   WHEN T1.Y5_AGE2 BETWEEN 80 AND 120 THEN '80-120'
			   ELSE 'Unknown' END
	) AS T2
 GROUP BY T2.[Attained Age]


--2024.05.17 v2

--DROP TABLE IF EXISTS #T1


--SELECT T3.*
--	  ,CASE WHEN T3.保單年度1 <= T3.DS OR T3.保單年度1 >= DE+1 THEN 0
--			WHEN DE <= T3.保單年度1 AND DS >= T3.保單年度1-1 THEN DE-DS
--			WHEN DE <= T3.保單年度1 AND DS <  T3.保單年度1-1 THEN DE-(T3.保單年度1-1)
--			WHEN DE > T3.保單年度1  AND DS >= T3.保單年度1-1 THEN T3.保單年度1-DS
--			WHEN DE > T3.保單年度1  AND DS <  T3.保單年度1-1 THEN T3.保單年度1-(T3.保單年度1-1)
--			END AS 'E(T)'
--	  ,CASE WHEN T3.保單年度2 <= T3.DS OR T3.保單年度2 >= DE+1 THEN 0
--			WHEN DE <= T3.保單年度2 AND DS >= T3.保單年度2-1 THEN DE-DS
--			WHEN DE <= T3.保單年度2 AND DS <  T3.保單年度2-1 THEN DE-(T3.保單年度2-1)
--			WHEN DE > T3.保單年度2  AND DS >= T3.保單年度2-1 THEN T3.保單年度2-DS
--			WHEN DE > T3.保單年度2  AND DS <  T3.保單年度2-1 THEN T3.保單年度2-(T3.保單年度2-1)
--			END AS 'E(J)'
--  INTO #T1
--  FROM (
--SELECT T2.[保單號碼]
--	  ,T2.[投保年齡]
--	  ,T2.Y5_AGE1
--	  ,T2.Y5_AGE2
--	  ,2023-YEAR(T2.[BR生效日]) AS '保單年度1'
--	  ,2023-YEAR(T2.[BR生效日]) + 1AS '保單年度2'
--	  ,T2.CLAIM
--	  ,T2.[BR生效日]
--	  ,T2.[START DATE OF STUDY PERIOD]
--	  ,DATEADD(DAY,1,T2.[END DATE OF STUDY PERIOD]) AS 'AA'
--	  ,T2.[狀態異動日(停效日回推26月)]
--	  ,CASE WHEN T2.[BR生效日] >= T2.[START DATE OF STUDY PERIOD] THEN CAST(DATEDIFF("D",T2.[BR生效日],T2.[BR生效日]) AS FLOAT)/365
--			WHEN T2.[BR生效日] <  T2.[START DATE OF STUDY PERIOD] THEN CAST(DATEDIFF("D",T2.[BR生效日],T2.[START DATE OF STUDY PERIOD]) AS FLOAT)/365
--			END AS 'DS'
--	  ,CASE WHEN T2.CLAIM = 'Y' THEN CASE WHEN T2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN CEILING(CAST(DATEDIFF("D",T2.[BR生效日],DATEADD(DAY,1,T2.[END DATE OF STUDY PERIOD])) AS FLOAT)/365)
--										  WHEN DATEADD(DAY,1,T2.[END DATE OF STUDY PERIOD]) <= T2.[狀態異動日(停效日回推26月)] THEN CEILING(CAST(DATEDIFF("D",T2.[BR生效日],DATEADD(DAY,1,T2.[END DATE OF STUDY PERIOD])) AS FLOAT)/365)
--										  WHEN DATEADD(DAY,1,T2.[END DATE OF STUDY PERIOD]) >  T2.[狀態異動日(停效日回推26月)] THEN CEILING(CAST(DATEDIFF("D",T2.[BR生效日],DATEADD(DAY,1,T2.[狀態異動日(停效日回推26月)])) AS FLOAT)/365)
--										  END
--			WHEN T2.CLAIM = 'N' THEN CASE WHEN T2.[狀態異動日(停效日回推26月)] = '1911-01-01' THEN CAST(DATEDIFF("D",T2.[BR生效日],DATEADD(DAY,1,T2.[END DATE OF STUDY PERIOD])) AS FLOAT)/365
--										  WHEN DATEADD(DAY,1,T2.[END DATE OF STUDY PERIOD]) <= T2.[狀態異動日(停效日回推26月)] THEN CAST(DATEDIFF("D",T2.[BR生效日],DATEADD(DAY,1,T2.[END DATE OF STUDY PERIOD])) AS FLOAT)/365
--										  WHEN DATEADD(DAY,1,T2.[END DATE OF STUDY PERIOD]) >  T2.[狀態異動日(停效日回推26月)] THEN CAST(DATEDIFF("D",T2.[BR生效日],DATEADD(DAY,1,T2.[狀態異動日(停效日回推26月)])) AS FLOAT)/365
--										  END
--			END AS 'DE'
-- FROM (
--SELECT T1.[保單號碼]
--	  ,T1.險種
--	  ,T1.[投保年齡]
--	  ,T1.Y5_AGE1
--	  ,T1.Y5_AGE2
--	  ,T1.[BR生效日]
--	  ,T1.[狀態異動日(停效日回推26月)]
--	  ,DATEFROMPARTS(2023,1,1) AS 'START DATE OF STUDY PERIOD'
--	  ,DATEFROMPARTS(2023,12,31) AS 'END DATE OF STUDY PERIOD'
--	  ,CASE WHEN T2.WFPOLN IS NOT NULL THEN 'Y'
--			WHEN T2.WFPOLN IS NULL THEN 'N'
--			END AS 'CLAIM'
--  FROM #FINAL AS T1
--  LEFT JOIN (
--				SELECT DISTINCT [WFPOLN]
--							   ,[WFPLAN]
--							   ,[WFTEFD]
--				  FROM [ESMM].[dbo].[0103_CLMB21WF_20240402_120000]
--				 WHERE 1 = 1 
--				   AND LEFT(WFPLAN,3) = 'HG1'
--				   AND [WFTEFD] > 1120000 AND [WFTEFD] < 1130000
--		)AS T2 ON T1.[保單號碼] = T2.WFPOLN AND T1.[險種] = T2.WFPLAN
-- WHERE 1 = 1
--   AND T1.Y5_件數 = 'Y'
-- ORDER BY 保單號碼
--   ) AS T2)T3


--SELECT *
--  FROM #FINAL AS T1
-- WHERE 1 = 1
--   AND T1.Y5_件數 = 'Y'

--SELECT Y5_AGE1,SUM(T1.AA)
--  FROM (
--SELECT Y5_AGE1,SUM(T1.[E(T)]) AS 'AA'
--  FROM #T1 AS T1
-- WHERE 1 = 1
-- GROUP BY Y5_AGE1
 
-- UNION ALL

--SELECT Y5_AGE2,SUM(T1.[E(J)]) AS 'AA'
--  FROM #T1 AS T1
-- WHERE 1 = 1
-- GROUP BY Y5_AGE2
-- )AS T1
--  GROUP BY Y5_AGE1
--  ORDER BY T1.Y5_AGE1 



--SELECT SUM(T1.[E(T)])
--  FROM #T1 AS T1
-- WHERE 1 = 1
--   AND T1.保單年度1 BETWEEN 11 AND 15

--SELECT SUM(T1.[E(J)])
--  FROM #T1 AS T1
-- WHERE 1 = 1
--   AND T1.保單年度2 BETWEEN 11 AND 15

--SELECT SUM(T1.[E(J)]),SUM(T1.[E(T)])
--  FROM #T1 AS T1